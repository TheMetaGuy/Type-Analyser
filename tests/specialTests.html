<!DOCTYPE html>
<html>
<head>
    <title>Main Test Page</title>
    <style>
        #log {
            width: 100%;
        }
    </style>    
    <script src="./dist-copy/type-master.iife.js"></script>
    <script>
        window.onload = function() {

            //  ========================================== Iframe tests ========================================== 

            var logIElem = document.getElementById('logI');
            function LogI(message) {
                console.log(message);
                logIElem.value += " - " + message + '\n';
            }

            var iframe = document.createElement('iframe');
            iframe.src = 'iframe.html';
            // make the iframe invisible
            iframe.style.display = 'none';

            document.body.appendChild(iframe);

            iframe.onload = function() {
                LogI('Main test page now sending object request messages to iframe\n');

                iframe.contentWindow.postMessage('send back Date object', '*');
                iframe.contentWindow.postMessage('send back Array object', '*');
                iframe.contentWindow.postMessage('send back Int8Array object', '*');
                iframe.contentWindow.postMessage('send back Float32Array object', '*');
                iframe.contentWindow.postMessage('send back Float64Array object', '*');
                iframe.contentWindow.postMessage('send back Error object', '*');
                iframe.contentWindow.postMessage('send back SyntaxError object', '*');
                iframe.contentWindow.postMessage('send back TypeError object', '*');
                iframe.contentWindow.postMessage('send back RangeError object', '*');
                iframe.contentWindow.postMessage('send back Blob object', '*');
                iframe.contentWindow.postMessage('send back File object', '*');
                iframe.contentWindow.postMessage('send back RegExp object', '*');
                iframe.contentWindow.postMessage('send back ArrayBuffer object', '*');
            };

            // Listen for a message event
            window.addEventListener('message', function(event) {
                if (event.origin !== 'http://localhost:9090' && event.origin !=="http://127.0.0.1:9090") return;

                var theObject = event.data.theData;
                var sentType = event.data.sentType;
                var typeOfMyObject = typeMaster.enhancedTypeOf(theObject);
                var result = (typeOfMyObject === sentType) ? 'PASS' : 'FAIL';

                LogI(result + ': Iframe test of enhancedTypeOf('+sentType+') gives ' + typeOfMyObject + ' with data = ' + theObject);
            });

            // ====================================== Worker Thread tests =========================================
            
            var logWElem = document.getElementById('logW');
            function LogW(message) {
                console.log(message);
                logWElem.value += " - " + message + '\n';
            }
            
            var worker = new Worker('worker.js');
            // send the off-screen canvas to the worker    
            var offScreenCanvas = document.querySelector('canvas').transferControlToOffscreen();
            worker.postMessage({canvas: offScreenCanvas}, [offScreenCanvas]);

            LogW('Main test page now sending object request messages to worker');
            LogW('test of worker object type give : ' + typeMaster.enhancedTypeOf(worker) + '\n' );

            worker.postMessage('send back Date object');
            worker.postMessage('send back Array object');
            worker.postMessage('send back Int8Array object');
            worker.postMessage('send back Float32Array object');
            worker.postMessage('send back Float64Array object');
            worker.postMessage('send back Error object');
            worker.postMessage('send back SyntaxError object');
            worker.postMessage('send back TypeError object');
            worker.postMessage('send back RangeError object');
            worker.postMessage('send back Blob object');
            worker.postMessage('send back File object');
            worker.postMessage('send back RegExp object');   
            worker.postMessage('send back ArrayBuffer object');
            worker.postMessage('send back ImageData object');

            worker.onmessage = function(event) {
                var theObject = event.data.theData;
                var sentType = event.data.sentType;
                var typeOfMyObject = typeMaster.enhancedTypeOf(theObject);
                var result = (typeOfMyObject === sentType) ? 'PASS' : 'FAIL';

                LogW(result + ': Worker test of enhancedTypeOf('+sentType+') gives ' + typeOfMyObject + ' with data = ' + theObject);
            }

            // ====================================== DOM elements tests =========================================

            var logHElem = document.getElementById('logH');
            function LogH(message) {
                console.log(message);
                logHElem.value += " - " + message + '\n';
            }

            // create a series of DOM elements and then test to see if we can detect the correct type of each one
            var div = document.createElement('div');
            var p = document.createElement('p');
            var span = document.createElement('span');
            var a = document.createElement('a');
            var img = document.createElement('img');
            var canvas = document.createElement('canvas');
            var video = document.createElement('video');
            var audio = document.createElement('audio');
            var source = document.createElement('source');
            var track = document.createElement('track');
            var table = document.createElement('table');
            
            LogH('Main test page now testing the detected type of DOM elements ===\n ' );
            LogH('div is a     - ' + typeMaster.enhancedTypeOf(div));
            LogH('p is a       - ' + typeMaster.enhancedTypeOf(p));
            LogH('span is a    - '  + typeMaster.enhancedTypeOf(span));
            LogH('a is a       - ' + typeMaster.enhancedTypeOf(a));
            LogH('img is a     - ' + typeMaster.enhancedTypeOf(img));
            LogH('canvas is a  - ' + typeMaster.enhancedTypeOf(canvas));
            LogH('video is a   - ' + typeMaster.enhancedTypeOf(video));
            LogH('audio is a   - ' + typeMaster.enhancedTypeOf(audio));
            LogH('source is a  - ' + typeMaster.enhancedTypeOf(source));
            LogH('track is a   - ' + typeMaster.enhancedTypeOf(track));
            LogH('table is a   - ' + typeMaster.enhancedTypeOf(table));
            LogH('iframe is a  - ' + typeMaster.enhancedTypeOf(iframe));

            // ====================================== End of tests =========================================

        };
    </script>
</head>
<body>
    <h3>TypeMaster Iframe Tests</h3>
    <textarea id="logI" rows="20" cols="180"></textarea>
    <h3>TypeMaster Worker Tests</h3>
    <textarea id="logW" rows="20" cols="180"></textarea>
    <!-- we don't need so actually display anything on the canvas -->
    <canvas id="myCanvas" width="1" height="1" style="border:1px solid #d3d3d3;">
        Your browser does not support the HTML canvas tag.
    </canvas>    
    <h3>DOM Element Tests</h3>
    <textarea id="logH" rows="20" cols="180"></textarea>
</body>
</html>
